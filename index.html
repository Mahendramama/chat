<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat – DeepSeek</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827;     /* gray-900 */
      --muted: #334155;     /* slate-600 */
      --border: #1f2937;    /* gray-800 */
      --text: #e5e7eb;      /* gray-200 */
      --text-dim: #cbd5e1;  /* slate-300 */
      --accent: #22d3ee;    /* cyan-400 */
      --accent-2: #a78bfa;  /* violet-400 */
      --green: #22c55e;
      --red: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(90vh 90vh at 10% 10%, #0b1220, #0f172a 60%),
                  radial-gradient(120vh 80vh at 100% 0%, #0b1120, #0f172a 40%);
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      height: 100dvh;
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header {
      border-bottom: 1px solid var(--border);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
      position: sticky; top: 0; z-index: 10;
    }
    .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 20px rgba(34, 211, 238, 0.25);
    }
    .title {
      font-weight: 700; letter-spacing: 0.2px;
    }
    .status {
      margin-left: auto; font-size: 12px; color: var(--text-dim);
      display: inline-flex; align-items: center; gap: 8px;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 999px; background: var(--green);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.6);
    }

    #chat {
      padding: 16px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
      overflow-y: auto;
    }
    .msg {
      display: grid; grid-template-columns: 40px 1fr; gap: 12px;
      padding: 14px 12px; border-radius: 16px; margin: 8px 0;
      border: 1px solid var(--border);
      background: rgba(17, 24, 39, 0.4);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .msg.user  { background: rgba(2,6,23,0.4); }
    .msg.assistant { background: rgba(17,24,39,0.6); }
    .avatar {
      width: 40px; height: 40px; border-radius: 12px; display: grid; place-items: center;
      background: #0b1220; border: 1px solid var(--border); color: var(--text-dim); font-weight: 700;
    }
    .avatar.ai {
      background: linear-gradient(135deg, #0a0f1f, #111827);
      border: 1px solid #1f2937;
      color: #a5b4fc;
    }
    .bubble {
      white-space: pre-wrap;
    }
    .bubble p { margin: 0.4em 0; }
    code, pre {
      background: #0b1020; border: 1px solid var(--border); border-radius: 8px; padding: 10px;
      overflow: auto; display: block;
    }

    form#composer {
      border-top: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
      padding: 16px; background: linear-gradient(0deg, rgba(255,255,255,0.03), transparent);
    }
    textarea {
      width: 100%; min-height: 56px; max-height: 220px; resize: vertical;
      background: #0b1220; color: var(--text); border: 1px solid var(--border);
      border-radius: 14px; padding: 12px 14px; outline: none;
      box-shadow: inset 0 0 0 1px transparent;
    }
    textarea:focus { box-shadow: inset 0 0 0 1px var(--accent); border-color: var(--accent); }
    button {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 16px; border-radius: 14px; border: 1px solid var(--border);
      background: linear-gradient(135deg, #0b1220, #111827);
      color: var(--text); cursor: pointer; font-weight: 600;
    }
    button:hover { box-shadow: 0 6px 20px rgba(0,0,0,0.25); transform: translateY(-1px); }
    .hint {
      font-size: 12px; color: var(--muted); text-align: center; margin: 6px 0 12px;
    }
    .toolbar {
      max-width: 900px; margin: 6px auto 0; padding: 0 16px;
      display: flex; gap: 8px; justify-content: flex-end; color: var(--muted); font-size: 12px;
    }
    .pill {
      border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px;
      cursor: pointer; user-select: none; background: rgba(255,255,255,0.03);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div class="title">DeepSeek Chat</div>
    <div class="status"><span class="dot"></span> ready</div>
  </header>

  <div id="chat" role="log" aria-live="polite" aria-busy="false"></div>

  <div class="toolbar">
    <div class="pill" id="clearBtn" title="Clear conversation">Clear</div>
    <div class="pill" id="exportBtn" title="Download conversation JSON">Export</div>
  </div>

  <form id="composer">
    <textarea id="input" placeholder="Ask anything... (Shift+Enter = new line)"></textarea>
    <button id="sendBtn" type="submit">Send ⮕</button>
  </form>

  <div class="hint">Your API key stays safe on the server (Netlify Function). No key in the browser.</div>

  <script>
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const formEl = document.getElementById("composer");
    const clearBtn = document.getElementById("clearBtn");
    const exportBtn = document.getElementById("exportBtn");

    // System prompt is optional. Keep minimal for general chat.
    const systemMessage = {
      role: "system",
      content: "You are a helpful, concise AI assistant."
    };

    let messages = [systemMessage];

    // Restore from localStorage
    (() => {
      const saved = localStorage.getItem("deepseek_chat_messages");
      if (saved) {
        try {
          messages = JSON.parse(saved);
          // Re-render
          for (const m of messages) {
            if (m.role === "system") continue;
            renderMessage(m.role, m.content);
          }
        } catch {}
      }
    })();

    function save() {
      localStorage.setItem("deepseek_chat_messages", JSON.stringify(messages));
    }

    function scrollToBottom() {
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function renderMessage(role, content) {
      const root = document.createElement("div");
      root.className = `msg ${role}`;
      const avatar = document.createElement("div");
      avatar.className = `avatar ${role === "assistant" ? "ai" : ""}`;
      avatar.textContent = role === "assistant" ? "AI" : "You";

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = content;

      root.appendChild(avatar);
      root.appendChild(bubble);
      chatEl.appendChild(root);
      scrollToBottom();
      return bubble; // return bubble to support "typing" effect
    }

    async function typeInto(el, text, speed = 1) {
      // Simulated typing without blocking too long
      if (speed <= 0) { el.textContent = text; return; }
      el.textContent = "";
      for (let i = 0; i < text.length; i++) {
        el.textContent += text[i];
        if (i % 2 === 0) await new Promise(r => setTimeout(r, 6)); // gentle
      }
    }

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        formEl.requestSubmit();
      }
    });

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const content = inputEl.value.trim();
      if (!content) return;

      // render user
      renderMessage("user", content);
      messages.push({ role: "user", content });
      save();
      inputEl.value = "";
      inputEl.focus();

      // render assistant placeholder
      const placeholder = renderMessage("assistant", "…");

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages,
            // Change model if your DeepSeek account uses another name (e.g., "deepseek-reasoner" or "deepseek-coder")
            model: "deepseek-chat",
            temperature: 0.7
          }),
        });

        const data = await res.json();
        if (!res.ok) {
          const err = data?.details || data?.error || "Request failed";
          await typeInto(placeholder, `⚠️ ${typeof err === "string" ? err : JSON.stringify(err, null, 2)}`, 0);
          return;
        }

        const reply = data.reply || "";
        await typeInto(placeholder, reply, 1);
        messages.push({ role: "assistant", content: reply });
        save();
      } catch (err) {
        await typeInto(placeholder, `⚠️ Network error: ${String(err)}`, 0);
      }
    });

    clearBtn.addEventListener("click", () => {
      if (!confirm("Clear this conversation?")) return;
      messages = [systemMessage];
      save();
      chatEl.innerHTML = "";
    });

    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(messages, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `deepseek-chat-${new Date().toISOString().slice(0,19)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
